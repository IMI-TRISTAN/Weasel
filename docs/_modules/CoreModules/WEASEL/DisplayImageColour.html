

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CoreModules.WEASEL.DisplayImageColour &mdash; Weasel 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/uni-sheffield-logo-16.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Weasel
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CoreModules.html">CoreModules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developer.html">Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../MenuItems.html">MenuItems</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Weasel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>CoreModules.WEASEL.DisplayImageColour</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for CoreModules.WEASEL.DisplayImageColour</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module contains functions for the display of a single DICOM image</span>
<span class="sd">or a series of DICOM images in an MDI subwindow that includes functionality</span>
<span class="sd">for the selecting and applying a colour table to the image/image series and</span>
<span class="sd">adjusting the contrast and intensity of the image/image series.  </span>
<span class="sd">It is possible to update the DICOM image/image series with the new </span>
<span class="sd">colour table, contrast &amp; intensity values.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtCore</span> 
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span>  <span class="n">Qt</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span><span class="n">QFileDialog</span><span class="p">,</span>                            
                            <span class="n">QMessageBox</span><span class="p">,</span> 
                            <span class="n">QWidget</span><span class="p">,</span> 
                            <span class="n">QGridLayout</span><span class="p">,</span> 
                            <span class="n">QVBoxLayout</span><span class="p">,</span> 
                            <span class="n">QMdiSubWindow</span><span class="p">,</span> 
                            <span class="n">QGroupBox</span><span class="p">,</span> 
                            <span class="n">QDoubleSpinBox</span><span class="p">,</span>
                            <span class="n">QPushButton</span><span class="p">,</span>  
                            <span class="n">QLabel</span><span class="p">,</span>  
                            <span class="n">QSlider</span><span class="p">,</span> 
                            <span class="n">QCheckBox</span><span class="p">,</span>  
                            <span class="n">QComboBox</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">iqr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">CoreModules.pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span> 
<span class="kn">import</span> <span class="nn">CoreModules.WEASEL.readDICOM_Image</span> <span class="k">as</span> <span class="nn">readDICOM_Image</span>
<span class="kn">import</span> <span class="nn">CoreModules.WEASEL.saveDICOM_Image</span> <span class="k">as</span> <span class="nn">saveDICOM_Image</span>
<span class="kn">import</span> <span class="nn">CoreModules.WEASEL.TreeView</span>  <span class="k">as</span> <span class="nn">treeView</span> 
<span class="kn">import</span> <span class="nn">CoreModules.WEASEL.DisplayImageCommon</span> <span class="k">as</span> <span class="nn">displayImageCommon</span>
<span class="kn">import</span> <span class="nn">CoreModules.WEASEL.MessageWindow</span>  <span class="k">as</span> <span class="nn">messageWindow</span>
<span class="kn">from</span> <span class="nn">CoreModules.WEASEL.UserImageColourSelection</span> <span class="kn">import</span> <span class="n">UserSelection</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">#List of colour tables supported by matplotlib</span>
<span class="n">listColours</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="s1">&#39;cividis&#39;</span><span class="p">,</span>  <span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="s1">&#39;Purples&#39;</span><span class="p">,</span> <span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">,</span> <span class="s1">&#39;Oranges&#39;</span><span class="p">,</span> <span class="s1">&#39;Reds&#39;</span><span class="p">,</span>
            <span class="s1">&#39;YlOrBr&#39;</span><span class="p">,</span> <span class="s1">&#39;YlOrRd&#39;</span><span class="p">,</span> <span class="s1">&#39;OrRd&#39;</span><span class="p">,</span> <span class="s1">&#39;PuRd&#39;</span><span class="p">,</span> <span class="s1">&#39;RdPu&#39;</span><span class="p">,</span> <span class="s1">&#39;BuPu&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GnBu&#39;</span><span class="p">,</span> <span class="s1">&#39;PuBu&#39;</span><span class="p">,</span> <span class="s1">&#39;YlGnBu&#39;</span><span class="p">,</span> <span class="s1">&#39;PuBuGn&#39;</span><span class="p">,</span> <span class="s1">&#39;BuGn&#39;</span><span class="p">,</span> <span class="s1">&#39;YlGn&#39;</span><span class="p">,</span>
            <span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;gist_yarg&#39;</span><span class="p">,</span> <span class="s1">&#39;gist_gray&#39;</span><span class="p">,</span> <span class="s1">&#39;bone&#39;</span><span class="p">,</span> <span class="s1">&#39;pink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;spring&#39;</span><span class="p">,</span> <span class="s1">&#39;summer&#39;</span><span class="p">,</span> <span class="s1">&#39;autumn&#39;</span><span class="p">,</span> <span class="s1">&#39;winter&#39;</span><span class="p">,</span> <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;Wistia&#39;</span><span class="p">,</span>
            <span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="s1">&#39;afmhot&#39;</span><span class="p">,</span> <span class="s1">&#39;gist_heat&#39;</span><span class="p">,</span> <span class="s1">&#39;copper&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PiYG&#39;</span><span class="p">,</span> <span class="s1">&#39;PRGn&#39;</span><span class="p">,</span> <span class="s1">&#39;BrBG&#39;</span><span class="p">,</span> <span class="s1">&#39;PuOr&#39;</span><span class="p">,</span> <span class="s1">&#39;RdGy&#39;</span><span class="p">,</span> <span class="s1">&#39;RdBu&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RdYlBu&#39;</span><span class="p">,</span> <span class="s1">&#39;RdYlGn&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectral&#39;</span><span class="p">,</span> <span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="s1">&#39;seismic&#39;</span><span class="p">,</span>
            <span class="s1">&#39;twilight&#39;</span><span class="p">,</span> <span class="s1">&#39;twilight_shifted&#39;</span><span class="p">,</span> <span class="s1">&#39;hsv&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;prism&#39;</span><span class="p">,</span> <span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;gist_earth&#39;</span><span class="p">,</span> <span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="s1">&#39;gist_stern&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gnuplot&#39;</span><span class="p">,</span> <span class="s1">&#39;gnuplot2&#39;</span><span class="p">,</span> <span class="s1">&#39;CMRmap&#39;</span><span class="p">,</span> <span class="s1">&#39;cubehelix&#39;</span><span class="p">,</span> <span class="s1">&#39;brg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gist_rainbow&#39;</span><span class="p">,</span> <span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="s1">&#39;nipy_spectral&#39;</span><span class="p">,</span> <span class="s1">&#39;gist_ncar&#39;</span><span class="p">,</span> <span class="s1">&#39;custom&#39;</span><span class="p">]</span>

<span class="c1">#Global variable for this module</span>
<span class="c1">#When several DICOM series of images are open at the the same time </span>
<span class="c1">#in WEASEL, the user may wish to switch between the various subwindows</span>
<span class="c1">#updating the colour table, intensity and contrast levels of one or more</span>
<span class="c1">#images in each series. This dictionary supports this by linking series </span>
<span class="c1">#name (key) to a list of sublists, userSelectionList (value), where each sublist </span>
<span class="c1">#        represents an image thus:</span>
<span class="c1">#            [0] - Image name (used as key to search the list of sublists for a particular image)</span>
<span class="c1">#            [1] - colour table name</span>
<span class="c1">#            [2] - intensity level</span>
<span class="c1">#            [3] - contrast level</span>
<span class="c1"># userSelectionList is initialised with default values in the function displayMultiImageSubWindow</span>
<span class="c1">#The class UserSelection in CoreModules.WEASEL.UserImageColourSelection supplies the functionality</span>
<span class="c1">#to manipulate userSelectionList. </span>
<span class="n">userSelectionDict</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="displayImageSubWindow"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.displayImageSubWindow">[docs]</a><span class="k">def</span> <span class="nf">displayImageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">derivedImagePath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a subwindow that displays a single DICOM image. </span>

<span class="sd">        Input Parmeters</span>
<span class="sd">        ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        studyName - string variable containing name of the DICOMstudy </span>
<span class="sd">                containing the DICOM series of images to be displayed</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series of images to be displayed</span>
<span class="sd">        derivedImagePath - optional parameter containing the path to a</span>
<span class="sd">            new image created by an operation on an existing image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DisplayImageColour.displayImageSubWindow called&quot;</span><span class="p">)</span>
            <span class="c1">#self.selectedImagePath is populated when the image in the</span>
            <span class="c1">#tree view is clicked &amp; selected</span>
            
            <span class="n">layout</span><span class="p">,</span> <span class="n">lblImageMissing</span><span class="p">,</span> <span class="n">subWindow</span> <span class="o">=</span> \
                <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">setUpImageViewerSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">windowTitle</span> <span class="o">=</span> <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">getDICOMFileData</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">subWindow</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">windowTitle</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">derivedImagePath</span><span class="p">:</span>
                <span class="n">imagePathForDisplay</span> <span class="o">=</span> <span class="n">derivedImagePath</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imagePathForDisplay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span>
            
            <span class="n">lblHiddenImagePath</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">imagePathForDisplay</span><span class="p">)</span>
            <span class="n">pixelArray</span> <span class="o">=</span> <span class="n">readDICOM_Image</span><span class="o">.</span><span class="n">returnPixelArray</span><span class="p">(</span><span class="n">imagePathForDisplay</span><span class="p">)</span>
            <span class="n">colourTable</span><span class="p">,</span> <span class="n">lut</span> <span class="o">=</span> <span class="n">readDICOM_Image</span><span class="o">.</span><span class="n">getColourmap</span><span class="p">(</span><span class="n">imagePathForDisplay</span><span class="p">)</span>

            <span class="n">lblHiddenImagePath</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="n">lblHiddenStudyName</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">studyName</span><span class="p">)</span>
            <span class="n">lblHiddenStudyName</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="n">lblHiddenSeriesName</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">seriesName</span><span class="p">)</span>
            <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            
            <span class="c1">#Maintain image data in hidden labels on the subwindow.</span>
            <span class="c1">#These values will used when updating an image with a</span>
            <span class="c1">#new colour table &amp; intensity &amp; contrast values. This</span>
            <span class="c1">#is done because several of these windows may be open</span>
            <span class="c1">#at once and the global self.selectedImagePath maybe</span>
            <span class="c1">#points to an image in a window other than the one</span>
            <span class="c1">#the user is working on</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblHiddenSeriesName</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblHiddenStudyName</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblHiddenImagePath</span><span class="p">)</span>

            <span class="n">spinBoxIntensity</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">()</span>
            <span class="n">spinBoxContrast</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">()</span>
            <span class="n">img</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">viewBox</span> <span class="o">=</span> <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">setUpViewBoxForImage</span><span class="p">(</span>                                               
                                                     <span class="n">layout</span><span class="p">,</span> 
                                                     <span class="n">spinBoxIntensity</span><span class="p">,</span> 
                                                     <span class="n">spinBoxContrast</span><span class="p">)</span>

            <span class="n">lblPixelValue</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;&lt;h4&gt;Pixel Value:&lt;/h4&gt;&quot;</span><span class="p">)</span>
            <span class="n">lblPixelValue</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblPixelValue</span><span class="p">)</span>
            
            <span class="n">cmbColours</span> <span class="o">=</span> <span class="n">setUpColourTools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>  
                                                <span class="n">lblHiddenImagePath</span><span class="p">,</span> <span class="n">lblHiddenSeriesName</span><span class="p">,</span> 
                                                <span class="n">lblHiddenStudyName</span><span class="p">,</span> 
                                                <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">)</span>
            
            <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">displayColourTableInComboBox</span><span class="p">(</span><span class="n">cmbColours</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">)</span>
            <span class="n">displayPixelArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelArray</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">lblImageMissing</span><span class="p">,</span>
                                    <span class="n">lblPixelValue</span><span class="p">,</span>
                                    <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                    <span class="n">imv</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span> <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                    <span class="n">lut</span><span class="p">)</span> 

        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">subWindow</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">msgBox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msgBox</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;View a DICOM series or image&quot;</span><span class="p">)</span>
                <span class="n">msgBox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Select either a series or an image&quot;</span><span class="p">)</span>
                <span class="n">msgBox</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.displayImageSubWindow: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in  DisplayImageColour.displayImageSubWindow: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> </div>


<div class="viewcode-block" id="displayMultiImageSubWindow"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.displayMultiImageSubWindow">[docs]</a><span class="k">def</span> <span class="nf">displayMultiImageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageList</span><span class="p">,</span> <span class="n">studyName</span><span class="p">,</span> 
                     <span class="n">seriesName</span><span class="p">,</span> <span class="n">sliderPosition</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a subwindow that displays all the DICOM images in a series. </span>
<span class="sd">        A slider allows the user to scroll through the images.  A delete</span>
<span class="sd">        button allows the user to delete the image they are viewing.</span>

<span class="sd">        The user can either update the whole series with a new colour table </span>
<span class="sd">        and contrast &amp; intensity values  or they can update individual</span>
<span class="sd">        images in the series with a new colour table </span>
<span class="sd">        and contrast &amp; intensity values.</span>

<span class="sd">        Input Parmeters</span>
<span class="sd">        ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        imageList - list of image file paths of the images in the series to be displayed</span>
<span class="sd">        studyName - string variable containing name of the DICOMstudy </span>
<span class="sd">                containing the DICOM series of images to be displayed</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series of images to be displayed</span>
<span class="sd">        sliderPosition - optional integer value denoting position of the slider widget that scrolls </span>
<span class="sd">            through the images in imageList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DisplayImageColour.displayMultiImageSubWindow called&quot;</span><span class="p">)</span>
            <span class="n">layout</span><span class="p">,</span> <span class="n">lblImageMissing</span><span class="p">,</span> <span class="n">subWindow</span> <span class="o">=</span> \
                <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">setUpImageViewerSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1">#set up list of lists to hold user selected colour table and level data</span>
            <span class="n">userSelectionList</span> <span class="o">=</span> <span class="p">[[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imageName</span><span class="p">),</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">imageName</span> <span class="ow">in</span> <span class="n">imageList</span><span class="p">]</span>
            <span class="c1">#add user selection object to dictionary</span>
            <span class="k">global</span> <span class="n">userSelectionDict</span>
            <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span> <span class="o">=</span> <span class="n">UserSelection</span><span class="p">(</span><span class="n">userSelectionList</span><span class="p">)</span>
            
            <span class="c1">#file path of the first image, </span>
            <span class="c1">#Study ID &amp; Series ID are stored locally on the</span>
            <span class="c1">#sub window as the text in label widgets</span>
            <span class="c1">#in case the user wishes to delete an</span>
            <span class="c1">#image in the series or update an image/image series</span>
            <span class="c1">#with new colour table, contrast &amp; intensity values.</span>
            <span class="c1">#They may have several series open at once,</span>
            <span class="c1">#so the selected series on the treeview</span>
            <span class="c1">#may not the same as that from which the image is</span>
            <span class="c1">#being deleted.</span>
            <span class="n">firstImagePath</span> <span class="o">=</span> <span class="n">imageList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lblHiddenImagePath</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">firstImagePath</span><span class="p">)</span>
            <span class="n">lblHiddenImagePath</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="n">lblHiddenStudyName</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">studyName</span><span class="p">)</span>
            <span class="n">lblHiddenStudyName</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="n">lblHiddenSeriesName</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">seriesName</span><span class="p">)</span>
            <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
            <span class="n">btnDeleteDICOMFile</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Delete DICOM Image&#39;</span><span class="p">)</span>
            <span class="n">btnDeleteDICOMFile</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
            <span class="s1">&#39;Deletes the DICOM image being viewed&#39;</span><span class="p">)</span>
            <span class="n">btnDeleteDICOMFile</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
         
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblHiddenImagePath</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblHiddenSeriesName</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblHiddenStudyName</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btnDeleteDICOMFile</span><span class="p">)</span>

            <span class="n">spinBoxIntensity</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">()</span>
            <span class="n">spinBoxContrast</span> <span class="o">=</span> <span class="n">QDoubleSpinBox</span><span class="p">()</span>
            <span class="n">imageSlider</span> <span class="o">=</span> <span class="n">QSlider</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Horizontal</span><span class="p">)</span>

            <span class="n">img</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">viewBox</span> <span class="o">=</span> <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">setUpViewBoxForImage</span><span class="p">(</span> 
                                                     <span class="n">layout</span><span class="p">,</span> <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">)</span> 
            <span class="n">lblPixelValue</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;&lt;h4&gt;Pixel Value:&lt;/h4&gt;&quot;</span><span class="p">)</span>
            <span class="n">lblPixelValue</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblPixelValue</span><span class="p">)</span>
            <span class="n">cmbColours</span> <span class="o">=</span> <span class="n">setUpColourTools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  
                                               <span class="n">lblHiddenImagePath</span><span class="p">,</span> <span class="n">lblHiddenSeriesName</span><span class="p">,</span> <span class="n">lblHiddenStudyName</span><span class="p">,</span> 
                                               <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                               <span class="n">imageSlider</span><span class="p">)</span>

            <span class="n">imageSlider</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">imageSlider</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imageList</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sliderPosition</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">imageSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imageSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">sliderPosition</span><span class="p">)</span>
            <span class="n">imageSlider</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">imageSlider</span><span class="o">.</span><span class="n">setTickPosition</span><span class="p">(</span><span class="n">QSlider</span><span class="o">.</span><span class="n">TicksBothSides</span><span class="p">)</span>
            <span class="n">imageSlider</span><span class="o">.</span><span class="n">setTickInterval</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">imageSlider</span><span class="p">)</span>
            <span class="n">imageSlider</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                  <span class="k">lambda</span><span class="p">:</span> <span class="n">imageSliderMoved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> 
                                                <span class="n">imageList</span><span class="p">,</span> 
                                                <span class="n">imageSlider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
                                                <span class="n">lblImageMissing</span><span class="p">,</span>
                                                <span class="n">lblPixelValue</span><span class="p">,</span>
                                                <span class="n">btnDeleteDICOMFile</span><span class="p">,</span>
                                                <span class="n">imv</span><span class="p">,</span> 
                                                <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                                <span class="n">cmbColours</span><span class="p">,</span>
                                                <span class="n">subWindow</span><span class="p">))</span>
           
            <span class="c1">#Display the first image in the viewer</span>
            <span class="n">imageSliderMoved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> 
                                  <span class="n">imageList</span><span class="p">,</span>
                                  <span class="n">imageSlider</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span>
                                  <span class="n">lblImageMissing</span><span class="p">,</span>
                                  <span class="n">lblPixelValue</span><span class="p">,</span>
                                  <span class="n">btnDeleteDICOMFile</span><span class="p">,</span>
                                  <span class="n">imv</span><span class="p">,</span> 
                                  <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                  <span class="n">cmbColours</span><span class="p">,</span>
                                  <span class="n">subWindow</span><span class="p">)</span>
            
            <span class="n">btnDeleteDICOMFile</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span>
                                               <span class="n">deleteImageInMultiImageViewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">,</span> 
                                      <span class="n">lblHiddenStudyName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span> 
                                      <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                      <span class="n">imageSlider</span><span class="o">.</span><span class="n">value</span><span class="p">()))</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">subWindow</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">msgBox</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span> 
                <span class="n">msgBox</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;View a DICOM series or image&quot;</span><span class="p">)</span>
                <span class="n">msgBox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Select either a series or an image&quot;</span><span class="p">)</span>
                <span class="n">msgBox</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>  
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.displayMultiImageSubWindow: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.displayMultiImageSubWindow: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="setUpColourTools"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.setUpColourTools">[docs]</a><span class="k">def</span> <span class="nf">setUpColourTools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layout</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span>
            <span class="n">singleImageSelected</span><span class="p">,</span>
            <span class="n">lblHiddenImagePath</span><span class="p">,</span>
            <span class="n">lblHiddenSeriesName</span><span class="p">,</span>
            <span class="n">lblHiddenStudyName</span><span class="p">,</span> <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>             
            <span class="n">imageSlider</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generates widgets for the display of a </span>
<span class="sd">            dropdown list containing colour tables</span>
<span class="sd">            and spin boxes for setting image contrast and intensity.</span>

<span class="sd">            Input Parmeters</span>
<span class="sd">            ***************</span>
<span class="sd">            self - an object reference to the WEASEL interface.</span>
<span class="sd">            layout - a QVBoxLayout widget that lines up widgets vertically.</span>
<span class="sd">                    The parent layout on the subwindow.</span>
<span class="sd">            imv - pyqtGraph imageView widget</span>
<span class="sd">            singleImageSelected - boolean variable, set to True if a </span>
<span class="sd">                    single image is being viewed. Otherwise set to False</span>
<span class="sd">            lblHiddenImagePath - name of the hidden label widget whose text</span>
<span class="sd">                    contains the path to an image file.</span>
<span class="sd">            lblHiddenSeriesName - name of the hidden label widget whose text</span>
<span class="sd">                    contains the name of the DICOM series whose images are </span>
<span class="sd">                    being viewed.</span>
<span class="sd">            lblHiddenStudyName - name of the hidden label widget whose text</span>
<span class="sd">                    contains the name of the DICOM study containing the series</span>
<span class="sd">                    whose images are  being viewed.</span>
<span class="sd">            spinBoxIntensity - name of the spinbox widget that displays/sets image intensity.</span>
<span class="sd">            spinBoxContrast - name of the spinbox widget that displays/sets image contrast.</span>
<span class="sd">            imageSlider - name of the slider widget used to scroll through the images.</span>

<span class="sd">        Output Parameters</span>
<span class="sd">        *****************</span>
<span class="sd">            cmbColours - A dropdown list of colour table names based on the QComboBox class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;displayImageColour.setUpColourTools called&quot;</span><span class="p">)</span>
            <span class="n">groupBoxColour</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s1">&#39;Colour Table&#39;</span><span class="p">)</span>
            <span class="n">groupBoxLevels</span> <span class="o">=</span> <span class="n">QGroupBox</span><span class="p">(</span><span class="s1">&#39;Levels&#39;</span><span class="p">)</span>
            <span class="c1">#gridLayoutColour will later be added to groupBoxLevels</span>
            <span class="n">gridLayoutColour</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">()</span>
            <span class="n">gridLayoutLevels</span> <span class="o">=</span> <span class="n">QGridLayout</span><span class="p">()</span>
            <span class="c1">#add grid layouts to the group boxes</span>
            <span class="n">groupBoxColour</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">gridLayoutColour</span><span class="p">)</span>
            <span class="n">groupBoxLevels</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">gridLayoutLevels</span><span class="p">)</span>
            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">groupBoxColour</span><span class="p">)</span>

            <span class="c1">#When this checkbox is checked, the selected colour table, </span>
            <span class="c1">#contrast and intensity levels are added to the whole series</span>
            <span class="n">chkApply</span> <span class="o">=</span> <span class="n">QCheckBox</span><span class="p">(</span><span class="s2">&quot;Apply Selection to whole series&quot;</span><span class="p">)</span>
            <span class="n">chkApply</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">applyColourTableToSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> 
                                                                         <span class="n">cmbColours</span><span class="p">,</span> 
                                                                         <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                                                         <span class="n">chkApply</span><span class="p">))</span>
            <span class="n">chkApply</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
                    <span class="s2">&quot;Tick to apply colour table and levels selected by the user to the whole series&quot;</span><span class="p">)</span>
       
            <span class="n">cmbColours</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
            <span class="n">cmbColours</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cmbColours</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">listColours</span><span class="p">)</span>
            <span class="n">cmbColours</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cmbColours</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">cmbColours</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s1">&#39;Select a colour table to apply to the image&#39;</span><span class="p">)</span>
            <span class="n">cmbColours</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span>
                        <span class="n">applyColourTableToSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span> <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span> <span class="n">chkApply</span><span class="p">))</span>

            <span class="n">btnUpdate</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Update&#39;</span><span class="p">)</span> 
            <span class="n">btnUpdate</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s1">&#39;Update DICOM with the new colour table, contrast &amp; intensity levels&#39;</span><span class="p">)</span>
            <span class="c1">#For the update button, connect signal to slot</span>
            <span class="k">if</span> <span class="n">singleImageSelected</span><span class="p">:</span>
                <span class="c1">#Viewing and potentially updating a single DICOM images</span>
                    <span class="n">btnUpdate</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">saveDICOM_Image</span><span class="o">.</span><span class="n">updateSingleDicomImage</span>
                                            <span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                            <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                            <span class="n">lblHiddenImagePath</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                                    <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                                    <span class="n">lblHiddenStudyName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                                    <span class="n">cmbColours</span><span class="o">.</span><span class="n">currentText</span><span class="p">(),</span>
                                                    <span class="n">lut</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Viewing and potentially updating a series of DICOM images</span>
                <span class="n">btnUpdate</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">updateDICOM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                                                <span class="n">lblHiddenSeriesName</span><span class="p">,</span>
                                                                <span class="n">lblHiddenStudyName</span><span class="p">,</span>
                                                                <span class="n">cmbColours</span><span class="p">,</span>
                                                                    <span class="n">spinBoxIntensity</span><span class="p">,</span> 
                                                                    <span class="n">spinBoxContrast</span><span class="p">))</span>
            
  
            <span class="n">btnExport</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Export&#39;</span><span class="p">)</span> 
            <span class="n">btnExport</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s1">&#39;Exports the image to an external graphic file.&#39;</span><span class="p">)</span>
            <span class="n">btnExport</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">exportImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">))</span>

            <span class="c1">#Levels </span>
            <span class="n">lblIntensity</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Centre (Intensity)&quot;</span><span class="p">)</span>
            <span class="n">lblContrast</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Width (Contrast)&quot;</span><span class="p">)</span>
            <span class="n">lblIntensity</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignRight</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            <span class="n">lblContrast</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignRight</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignVCenter</span><span class="p">)</span>
            
            <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="o">-</span><span class="mf">100000.00</span><span class="p">)</span>
            <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">setMinimum</span><span class="p">(</span><span class="o">-</span><span class="mf">100000.00</span><span class="p">)</span>
            <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mf">1000000000.00</span><span class="p">)</span>
            <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mf">1000000000.00</span><span class="p">)</span>
            <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">setWrapping</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">setWrapping</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">updateImageLevels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">imv</span><span class="p">,</span><span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">))</span>
            <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">updateImageLevels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">imv</span><span class="p">,</span><span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">singleImageSelected</span><span class="p">:</span> <span class="c1">#series selected</span>
                <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">updateImageUserSelection</span><span class="p">(</span>
                                                      <span class="bp">self</span><span class="p">,</span>  <span class="n">chkApply</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span>
                                                      <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                                      <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                                      <span class="n">lblHiddenImagePath</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
                <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">updateImageUserSelection</span><span class="p">(</span>
                                                      <span class="bp">self</span><span class="p">,</span>  <span class="n">chkApply</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span>
                                                      <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                                      <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                                      <span class="n">lblHiddenImagePath</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>

            <span class="n">gridLayoutLevels</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblIntensity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">gridLayoutLevels</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">gridLayoutLevels</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">lblContrast</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">gridLayoutLevels</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">spinBoxContrast</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">cmbColours</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">singleImageSelected</span><span class="p">:</span> <span class="c1">#series selected</span>
                <span class="c1">#Viewing a DICOM series, so show the Reset button</span>
                <span class="c1">#and Apply to Series checkbox</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">chkApply</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">btnReset</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s1">&#39;Reset&#39;</span><span class="p">)</span> 
                <span class="n">btnReset</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s1">&#39;Return to colour tables and levels in the DICOM file&#39;</span><span class="p">)</span>
                <span class="c1">#Clicking Reset button deletes user selected colour table and contrast </span>
                <span class="c1">#and intensity levelts and returns images to values in the original DICOM file.</span>
                <span class="n">btnReset</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">clearUserSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageSlider</span><span class="p">,</span>
                                                                   <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btnReset</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btnUpdate</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btnExport</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">groupBoxLevels</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">cmbColours</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span>
                        <span class="n">updateImageUserSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">chkApply</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span>
                                                      <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                                      <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                                                      <span class="n">lblHiddenImagePath</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btnUpdate</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">btnExport</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">gridLayoutColour</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">groupBoxLevels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">cmbColours</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in displayImageColour.setUpColourTools: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in displayImageColour.setUpColourTools: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="displayPixelArray"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.displayPixelArray">[docs]</a><span class="k">def</span> <span class="nf">displayPixelArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelArray</span><span class="p">,</span> <span class="n">currentImageNumber</span><span class="p">,</span>
                          <span class="n">lblImageMissing</span><span class="p">,</span> <span class="n">lblPixelValue</span><span class="p">,</span>
                          <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                          <span class="n">imv</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span> 
                          <span class="n">seriesName</span><span class="p">,</span>
                          <span class="n">lut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">multiImage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deleteButton</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Displays the an image&#39;s pixel array in a pyqtGraph imageView widget </span>
<span class="sd">        &amp; sets its colour table, contrast and intensity levels. </span>
<span class="sd">        Also, sets the contrast and intensity in the associated histogram.</span>
<span class="sd">        </span>
<span class="sd">        Input Parmeters</span>
<span class="sd">        ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        pixelArray - pixel array to be displayed in imv</span>
<span class="sd">        currentImageNumber - ordinal number of the image to be displayed</span>
<span class="sd">                in the list of images forming the series.</span>
<span class="sd">        lblImageMissing - Label widget that displays the text &#39;Missing Image&#39;</span>
<span class="sd">        lblPixelValue - Label widget that displays the value of the pixel under the mouse pointer</span>
<span class="sd">                and the X,Y coordinates of the mouse pointer.</span>
<span class="sd">        spinBoxIntensity - name of the spinbox widget that displays/sets image intensity.</span>
<span class="sd">        spinBoxContrast - name of the spinbox widget that displays/sets image contrast.</span>
<span class="sd">        imv - pyqtGraph imageView widget</span>
<span class="sd">        colourTable - String variable containing the name of a colour table</span>
<span class="sd">        cmbColours - Name of the dropdown list of colour table names</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series </span>
<span class="sd">            of images to be displayed</span>
<span class="sd">        lut - array holding a lookup table of colours. A custom colour map</span>
<span class="sd">        multiImage - optional boolean variable, default False,</span>
<span class="sd">                    set to True if a series of DICOM images is being viewed.</span>
<span class="sd">        deleteButton - name of the button widget, which when </span>
<span class="sd">                clicked causes an image to be deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DisplayImageColour.displayPixelArray called&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">multiImage</span><span class="p">:</span>
                <span class="c1">#only show delete button when viewing a series</span>
                <span class="n">deleteButton</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Create dummy button to prevent runtime error</span>
                <span class="c1">#This is the case when viewing a single image</span>
                <span class="n">deleteButton</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">()</span>
                <span class="n">deleteButton</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

            <span class="c1">#Check that pixel array holds an image &amp; display it</span>
            <span class="k">if</span> <span class="n">pixelArray</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#the image is missing, so show a black screen</span>
                <span class="n">lblImageMissing</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">deleteButton</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
                <span class="n">imv</span><span class="o">.</span><span class="n">setImage</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]))</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">multiImage</span><span class="p">:</span> <span class="c1">#series</span>
                    <span class="n">centre</span> <span class="o">=</span> <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
                    <span class="n">success</span><span class="p">,</span> <span class="n">minimumValue</span><span class="p">,</span> <span class="n">maximumValue</span> <span class="o">=</span> <span class="n">returnUserSelectedLevels</span><span class="p">(</span><span class="n">seriesName</span><span class="p">,</span> 
                                                                               <span class="n">centre</span><span class="p">,</span> 
                                                                               <span class="n">width</span><span class="p">,</span> 
                                                                               <span class="n">currentImageNumber</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">centre</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">maximumValue</span><span class="p">,</span> <span class="n">minimumValue</span> <span class="o">=</span> <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">readLevelsFromDICOMImage</span><span class="p">(</span>
                                                                                            <span class="bp">self</span><span class="p">,</span> <span class="n">pixelArray</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>  <span class="c1">#single image </span>
                    <span class="n">centre</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">maximumValue</span><span class="p">,</span> <span class="n">minimumValue</span> <span class="o">=</span> <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">readLevelsFromDICOMImage</span><span class="p">(</span>
                                                                                        <span class="bp">self</span><span class="p">,</span> <span class="n">pixelArray</span><span class="p">)</span>

                <span class="n">blockLevelsSpinBoxSignals</span><span class="p">(</span><span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">centre</span><span class="p">)</span>
                <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
                <span class="n">blockLevelsSpinBoxSignals</span><span class="p">(</span><span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">blockHistogramSignals</span><span class="p">(</span><span class="n">imv</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">imv</span><span class="o">.</span><span class="n">setImage</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">,</span> <span class="n">autoHistogramRange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">(</span><span class="n">minimumValue</span><span class="p">,</span> <span class="n">maximumValue</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">imv</span><span class="o">.</span><span class="n">setImage</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">,</span> <span class="n">autoHistogramRange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="p">(</span><span class="n">minimumValue</span><span class="p">,</span> <span class="n">maximumValue</span><span class="p">))</span>
                <span class="n">blockHistogramSignals</span><span class="p">(</span><span class="n">imv</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
                <span class="c1">#Add Colour Table or look up table To Image</span>
                <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">setPgColourMap</span><span class="p">(</span><span class="n">colourTable</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span> <span class="n">lut</span><span class="p">)</span>

                <span class="n">lblImageMissing</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>   
  
                <span class="n">imv</span><span class="o">.</span><span class="n">getView</span><span class="p">()</span><span class="o">.</span><span class="n">scene</span><span class="p">()</span><span class="o">.</span><span class="n">sigMouseMoved</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                   <span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">getPixelValue</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">pixelArray</span><span class="p">,</span> <span class="n">lblPixelValue</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.displayPixelArray: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.displayPixelArray: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="returnUserSelectedLevels"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.returnUserSelectedLevels">[docs]</a><span class="k">def</span> <span class="nf">returnUserSelectedLevels</span><span class="p">(</span><span class="n">seriesName</span><span class="p">,</span> <span class="n">centre</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">currentImageNumber</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When the user has selected new image levels that must override the </span>
<span class="sd">    levels saved in the DICOM series/image, this function returns those selected levels</span>

<span class="sd">    Input parameters</span>
<span class="sd">    ****************</span>
<span class="sd">    seriesName - string variable containing the name of DICOM series of images to be displayed</span>
<span class="sd">    centre - Image intensity</span>
<span class="sd">    width - Image contrast</span>
<span class="sd">    currentImageNumber - The ordinal number of the image being viewed in the image list</span>

<span class="sd">    Output parameters</span>
<span class="sd">    *****************</span>
<span class="sd">    success - boolean, set to true if level values are successfully retrieved</span>
<span class="sd">    maximumValue - Maximum pixel value in the image</span>
<span class="sd">    minimumValue - Minimum pixel value in the image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DisplayImageColour.returnUserSelectedLevels called&quot;</span><span class="p">)</span>
        <span class="n">minimumValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">maximumValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">global</span> <span class="n">userSelectionDict</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">getSeriesUpdateStatus</span><span class="p">():</span>
            <span class="c1">#apply contrast and intensity values</span>
            <span class="c1">#selected in the GUI spinboxes</span>
            <span class="c1">#for the whole series to this image</span>
            <span class="n">minimumValue</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">maximumValue</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">getImageUpdateStatus</span><span class="p">():</span>
            <span class="c1">#the user has opted to change the levels of individual images</span>
            <span class="c1">#in a series.</span>
            <span class="c1">#if user selected levels exist for this image, retrieve them</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">centre</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">returnUserSelection</span><span class="p">(</span><span class="n">currentImageNumber</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">centre</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1">#saved values exist, so use them</span>
                <span class="n">minimumValue</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">maximumValue</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">minimumValue</span><span class="p">,</span> <span class="n">maximumValue</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.returnUserSelectedLevels: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.returnUserSelectedLevels: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="blockLevelsSpinBoxSignals"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.blockLevelsSpinBoxSignals">[docs]</a><span class="k">def</span> <span class="nf">blockLevelsSpinBoxSignals</span><span class="p">(</span><span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Toggles (off/on) blocking the signals from the spinboxes associated </span>
<span class="sd">    with input of intensity and contrast values. </span>
<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        spinBoxIntensity - name of the spinbox widget that displays/sets image intensity.</span>
<span class="sd">        spinBoxContrast - name of the spinbox widget that displays/sets image contrast.</span>
<span class="sd">        block - boolean taking values True/False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="n">block</span><span class="p">)</span></div>


<div class="viewcode-block" id="blockHistogramSignals"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.blockHistogramSignals">[docs]</a><span class="k">def</span> <span class="nf">blockHistogramSignals</span><span class="p">(</span><span class="n">imgView</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Toggles (off/on) blocking the signals from the histogram associated </span>
<span class="sd">        with image view imgView. </span>
<span class="sd">        Input Parmeters</span>
<span class="sd">        ***************</span>
<span class="sd">            imgView - name of the imageView widget associated with the histogram</span>
<span class="sd">            block - boolean taking values True/False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">histogramObject</span> <span class="o">=</span> <span class="n">imgView</span><span class="o">.</span><span class="n">getHistogramWidget</span><span class="p">()</span><span class="o">.</span><span class="n">getHistogram</span><span class="p">()</span>
        <span class="n">histogramObject</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="n">block</span><span class="p">)</span></div>


<div class="viewcode-block" id="imageSliderMoved"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.imageSliderMoved">[docs]</a><span class="k">def</span> <span class="nf">imageSliderMoved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">imageList</span><span class="p">,</span> <span class="n">imageNumber</span><span class="p">,</span>
                        <span class="n">lblImageMissing</span><span class="p">,</span> <span class="n">lblPixelValue</span><span class="p">,</span> 
                        <span class="n">btnDeleteDICOMFile</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> 
                        <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                        <span class="n">cmbColours</span><span class="p">,</span>
                        <span class="n">subWindow</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;On the Multiple Image Display sub window, this</span>
<span class="sd">        function is called when the image slider is moved. </span>
<span class="sd">        It causes the next image in imageList to be displayed</span>
<span class="sd">        </span>
<span class="sd">        self - object reference to the WEASEL GUI</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series of images to be displayed</span>
<span class="sd">        lblImageMissing - Label widget that displays the text &#39;Missing Image&#39;</span>
<span class="sd">        lblPixelValue - Label widget that displays the value of the pixel under the mouse pointer</span>
<span class="sd">                and the X,Y coordinates of the mouse pointer.</span>
<span class="sd">        imv - pyqtGraph imageView widget</span>
<span class="sd">        imageList - list of image file paths of the images in the series to be displayed</span>
<span class="sd">        spinBoxIntensity - name of the spinbox widget that displays/sets image intensity.</span>
<span class="sd">        spinBoxContrast - name of the spinbox widget that displays/sets image contrast.</span>
<span class="sd">        cmbColours - A dropdown list of colour table names based on the QComboBox class</span>
<span class="sd">        subWindow - object reference to the subwindow hosting the slider control</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">userSelectionDict</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DisplayImageColour.imageSliderMoved called&quot;</span><span class="p">)</span>
            <span class="n">currentImageNumber</span> <span class="o">=</span> <span class="n">imageNumber</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">currentImageNumber</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span> <span class="o">=</span> <span class="n">imageList</span><span class="p">[</span><span class="n">currentImageNumber</span><span class="p">]</span>
                <span class="c1">#print(&quot;imageSliderMoved before={}&quot;.format(self.selectedImagePath))</span>
                <span class="n">pixelArray</span> <span class="o">=</span> <span class="n">readDICOM_Image</span><span class="o">.</span><span class="n">returnPixelArray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">)</span>
                <span class="n">lut</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1">#Get colour table of the image to be displayed</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">getSeriesUpdateStatus</span><span class="p">():</span>
                    <span class="n">colourTable</span> <span class="o">=</span> <span class="n">cmbColours</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">getImageUpdateStatus</span><span class="p">():</span>
                    <span class="n">colourTable</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">returnUserSelection</span><span class="p">(</span><span class="n">currentImageNumber</span><span class="p">)</span>  
                    <span class="k">if</span> <span class="n">colourTable</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                        <span class="n">colourTable</span><span class="p">,</span> <span class="n">lut</span> <span class="o">=</span> <span class="n">readDICOM_Image</span><span class="o">.</span><span class="n">getColourmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">)</span>
                    <span class="c1">#print(&#39;apply User Selection, colour table {}, image number {}&#39;.format(colourTable,currentImageNumber ))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colourTable</span><span class="p">,</span> <span class="n">lut</span> <span class="o">=</span> <span class="n">readDICOM_Image</span><span class="o">.</span><span class="n">getColourmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">)</span>

                <span class="c1">#display above colour table in colour table dropdown list</span>
                <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">displayColourTableInComboBox</span><span class="p">(</span><span class="n">cmbColours</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">)</span>

                <span class="n">displayPixelArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelArray</span><span class="p">,</span> <span class="n">currentImageNumber</span><span class="p">,</span> 
                                       <span class="n">lblImageMissing</span><span class="p">,</span>
                                       <span class="n">lblPixelValue</span><span class="p">,</span>
                                       <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                                       <span class="n">imv</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">,</span>
                                       <span class="n">cmbColours</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span>
                                       <span class="n">lut</span><span class="p">,</span>
                                       <span class="n">multiImage</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  
                                       <span class="n">deleteButton</span><span class="o">=</span><span class="n">btnDeleteDICOMFile</span><span class="p">)</span> 

                <span class="n">subWindow</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">seriesName</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> 
                         <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">))</span>
              
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.imageSliderMoved: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.imageSliderMoved: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="deleteImageInMultiImageViewer"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.deleteImageInMultiImageViewer">[docs]</a><span class="k">def</span> <span class="nf">deleteImageInMultiImageViewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currentImagePath</span><span class="p">,</span> 
                                      <span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span>
                                      <span class="n">lastSliderPosition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When the Delete button is clicked on the multi image viewer,</span>
<span class="sd">    this function deletes the physical image, removes the </span>
<span class="sd">    reference to it in the XML file and removes it from the image viewer.</span>
<span class="sd">    </span>
<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        currentImagePath - file path to the image being viewed.</span>
<span class="sd">        studyName - string variable containing name of the DICOMstudy </span>
<span class="sd">                containing the DICOM series of images to be displayed</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series</span>
<span class="sd">                of images to be displayed</span>
<span class="sd">        lastSliderPosition - integer variable holding the value of the </span>
<span class="sd">                    slider when the delete button is clicked; i.e., the</span>
<span class="sd">                    number of the image being deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DisplayImageColour.deleteImageInMultiImageViewer called&quot;</span><span class="p">)</span>
        <span class="n">imageName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">currentImagePath</span><span class="p">)</span>
        <span class="c1">#print (&#39;study id {} series id {}&#39;.format(studyName, seriesName))</span>
        <span class="n">buttonReply</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="s1">&#39;Delete DICOM image&#39;</span><span class="p">,</span> <span class="s2">&quot;You are about to delete image </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imageName</span><span class="p">),</span> 
            <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">,</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Cancel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">buttonReply</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">:</span>
            <span class="c1">#Delete physical file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">currentImagePath</span><span class="p">)</span>
            <span class="c1">#Remove deleted image from the list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">currentImagePath</span><span class="p">)</span>

            <span class="c1">#Refresh the multi-image viewer to remove deleted image</span>
            <span class="c1">#First close it</span>
            <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">closeSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#Only redisplay the multi-image viewer if there</span>
                <span class="c1">#are still images in the series to display</span>
                <span class="c1">#The image list is empty, so do not redisplay</span>
                <span class="c1">#multi image viewer </span>
                <span class="k">pass</span>   
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#There is only one image left in the display</span>
                <span class="n">displayMultiImageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="p">,</span> <span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">lastSliderPosition</span><span class="p">:</span>    
                    <span class="c1">#we are deleting the last image in the series of images</span>
                    <span class="c1">#so move the slider back to the penultimate image in list </span>
                <span class="n">displayMultiImageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="p">,</span> 
                                    <span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#We are deleting an image at the start of the list</span>
                <span class="c1">#or in the body of the list. Move slider forwards to </span>
                <span class="c1">#the next image in the list.</span>
                <span class="n">displayMultiImageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imageList</span><span class="p">,</span> 
                                    <span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">lastSliderPosition</span><span class="p">)</span>
     
            <span class="c1">#Now update XML file</span>
            <span class="c1">#Get the series containing this image and count the images it contains</span>
            <span class="c1">#If it is the last image in a series then remove the</span>
            <span class="c1">#whole series from XML file</span>
            <span class="c1">#If it is not the last image in a series</span>
            <span class="c1">#just remove the image from the XML file </span>
            <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objXMLReader</span><span class="o">.</span><span class="n">getImageList</span><span class="p">(</span><span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#only one image, so remove the series from the xml file</span>
                <span class="c1">#need to get study (parent) containing this series (child)</span>
                <span class="c1">#then remove child from parent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">objXMLReader</span><span class="o">.</span><span class="n">removeSeriesFromXMLFile</span><span class="p">(</span><span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#more than 1 image in the series, </span>
                <span class="c1">#so just remove the image from the xml file</span>
                <span class="c1">##need to get the series (parent) containing this image (child)</span>
                <span class="c1">##then remove child from parent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">objXMLReader</span><span class="o">.</span><span class="n">removeOneImageFromSeries</span><span class="p">(</span>
                    <span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">currentImagePath</span><span class="p">)</span>
            <span class="c1">#Update tree view with xml file modified above</span>
            <span class="n">treeView</span><span class="o">.</span><span class="n">refreshDICOMStudiesTreeView</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.deleteImageInMultiImageViewer: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.deleteImageInMultiImageViewer: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="exportImage"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.exportImage">[docs]</a><span class="k">def</span> <span class="nf">exportImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function executed when the Export button is clicked.  </span>
<span class="sd">    It exports the DICOM image and its colour table to a png graphics file.</span>
<span class="sd">    It launches a file dialog, so that the user can select the file path to </span>
<span class="sd">    the png file in which the exported file will be stored. It also collects </span>
<span class="sd">    the name of the image colour table and the image levels.</span>
<span class="sd">    </span>
<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        imv - pyqtGraph imageView widget</span>
<span class="sd">        cmbColours - A dropdown list of colour table names based on the QComboBox class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">colourTable</span> <span class="o">=</span> <span class="n">cmbColours</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="c1">#Default file name is derived from the DICOM image name</span>
        <span class="n">defaultImageName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">)</span> 
        <span class="c1">#remove .dcm extension</span>
        <span class="n">defaultImageName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">defaultImageName</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="c1">#Display a save file dialog to get the full file path and name of</span>
        <span class="c1">#where to export the DICOM image &amp; its colour table to a png file</span>
        <span class="n">fileName</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="s2">&quot;Enter a file name&quot;</span><span class="p">,</span> 
                                                    <span class="n">directory</span><span class="o">=</span><span class="n">defaultImageName</span><span class="p">,</span> 
                                                    <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;*.png&quot;</span><span class="p">)</span>
        <span class="n">minimumValue</span><span class="p">,</span> <span class="n">maximumValue</span> <span class="o">=</span> <span class="n">imv</span><span class="o">.</span><span class="n">getLevels</span><span class="p">()</span>

        <span class="c1">#Test if the user has selected a file name</span>
        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">exportImageViaMatplotlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imv</span><span class="o">.</span><span class="n">getImageItem</span><span class="p">()</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                                            <span class="n">fileName</span><span class="p">,</span> 
                                            <span class="n">colourTable</span><span class="p">,</span>
                                             <span class="n">minimumValue</span><span class="p">,</span>
                                            <span class="n">maximumValue</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.exportImage: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.exportImage: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="exportImageViaMatplotlib"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.exportImageViaMatplotlib">[docs]</a><span class="k">def</span> <span class="nf">exportImageViaMatplotlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixelArray</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">,</span>  <span class="n">minimumValue</span><span class="p">,</span> <span class="n">maximumValue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function uses matplotlib.pyplot to save the DICOM image being viewed </span>
<span class="sd">    and its colour table in a png file with the path+filename in fileName. </span>
<span class="sd">    </span>
<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        pixelArray - pixel array to be exported as a png file</span>
<span class="sd">        fileName - file path to the png file in which the exported file will be stored.</span>
<span class="sd">        colourTable - String variable containing the name of a colour table</span>
<span class="sd">        maximumValue - Maximum pixel value in the image</span>
<span class="sd">        minimumValue - Minimum pixel value in the image</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="n">axisOrder</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">getConfigOption</span><span class="p">(</span><span class="s1">&#39;imageAxisOrder&#39;</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">axisOrder</span> <span class="o">==</span><span class="s1">&#39;row-major&#39;</span><span class="p">:</span>
            <span class="c1">#Transpose the array so as to match the screen image </span>
            <span class="c1"># (a transpose is already applied when reading DICO image)</span>
            <span class="n">pixelArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colourTable</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">,</span>  <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">minimumValue</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">maximumValue</span><span class="p">))</span>
        <span class="n">cBar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">cBar</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Export Image&quot;</span><span class="p">,</span> <span class="s2">&quot;Image Saved&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.exportImageViaMatplotlib: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.exportImageViaMatplotlib: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="applyColourTableToSeries"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.applyColourTableToSeries">[docs]</a><span class="k">def</span> <span class="nf">applyColourTableToSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">applySeriesCheckBox</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;This function applies a user selected colour map to the current image.</span>
<span class="sd">    If the Apply checkbox is checked then the new colour map is also applied to </span>
<span class="sd">    the whole series of DICOM images by setting a boolean flag to True.</span>

<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        imv - pyqtGraph imageView widget</span>
<span class="sd">        cmbColours - A dropdown list of colour table names based on the QComboBox class</span>
<span class="sd">        seriesName - string variable containing the name of </span>
<span class="sd">            DICOM series of images to be displayed</span>
<span class="sd">        applySeriesCheckBox - Name of the apply user selection to the whole series checkbox widget</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">userSelectionDict</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">colourTable</span> <span class="o">=</span> <span class="n">cmbColours</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">colourTable</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="n">colourTable</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>                
            <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">displayColourTableInComboBox</span><span class="p">(</span><span class="n">cmbColours</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>   

        <span class="n">displayImageCommon</span><span class="o">.</span><span class="n">setPgColourMap</span><span class="p">(</span><span class="n">colourTable</span><span class="p">,</span> <span class="n">imv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">applySeriesCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setSeriesUpdateStatus</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setImageUpdateStatus</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">setSeriesUpdateStatus</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
               
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.applyColourTableToSeries: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.applyColourTableToSeries: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>              </div>
        

<div class="viewcode-block" id="clearUserSelection"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.clearUserSelection">[docs]</a><span class="k">def</span> <span class="nf">clearUserSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageSlider</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function removes the user selected colour tables, contrast &amp; intensity values from</span>
<span class="sd">    the list of image lists that hold these values.  They are reset to the default values of</span>
<span class="sd">    &#39;default&#39; for the colour table and -1 for the contrast &amp; intensity values</span>
<span class="sd">    </span>
<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        imageSlider - name of the slider widget used to scroll through the images.</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series of images to be displayed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">userSelectionDict</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">clearUserSelection</span><span class="p">()</span>

    <span class="c1">#reload current image to display it without user selected </span>
    <span class="c1">#colour table and levels.</span>
    <span class="c1">#This is done by advancing the slider and then moving it  </span>
    <span class="c1">#back to the original image</span>
    <span class="k">if</span> <span class="n">imageSlider</span><span class="p">:</span>
        <span class="n">imageNumber</span> <span class="o">=</span> <span class="n">imageSlider</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">imageNumber</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tempNumber</span> <span class="o">=</span> <span class="n">imageNumber</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tempNumber</span> <span class="o">=</span> <span class="n">imageNumber</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">imageSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">tempNumber</span><span class="p">)</span>
        <span class="n">imageSlider</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">imageNumber</span><span class="p">)</span></div>
                    

<div class="viewcode-block" id="updateImageUserSelection"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.updateImageUserSelection">[docs]</a><span class="k">def</span> <span class="nf">updateImageUserSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">applySeriesCheckBox</span><span class="p">,</span> 
                             <span class="n">cmbColours</span><span class="p">,</span>
                             <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">,</span>
                             <span class="n">seriesName</span><span class="p">,</span> 
                             <span class="n">firstImagePath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When the colour table &amp; levels associated with an image are changed, their values</span>
<span class="sd">        are associated with that image in the list of lists userSelectionList, where each sublist </span>
<span class="sd">        represents an image thus:</span>
<span class="sd">            [0] - Image name (used as key to search the list of lists)</span>
<span class="sd">            [1] - colour table name</span>
<span class="sd">            [2] - intensity level</span>
<span class="sd">            [3] - contrast level</span>
<span class="sd">        userSelectionList is initialised with default values in the function displayMultiImageSubWindow</span>
<span class="sd">        </span>
<span class="sd">        Input Parmeters</span>
<span class="sd">        ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        applySeriesCheckBox - Name of the apply user selection to the whole series checkbox widget</span>
<span class="sd">        cmbColours - A dropdown list of colour table names based on the QComboBox class </span>
<span class="sd">        spinBoxIntensity - name of the spinbox widget that displays/sets image intensity.</span>
<span class="sd">        spinBoxContrast - name of the spinbox widget that displays/sets image contrast.</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series of images to be displayed</span>
<span class="sd">        firstImagePath - string variable containing the file path to the first image in the DICOM series</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updateImageUserSelection called&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">applySeriesCheckBox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1">#The apply user selection to whole series checkbox </span>
            <span class="c1">#is not checked</span>

            <span class="n">colourTable</span> <span class="o">=</span> <span class="n">cmbColours</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectedImageName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedImagePath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#Workaround for the fact that when the first image is displayed,</span>
                <span class="c1">#somehow self.selectedImageName looses its value.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectedImageName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">firstImagePath</span><span class="p">)</span>
            
            <span class="c1">#print(&quot;self.selectedImageName ={}&quot;.format(self.selectedImageName))</span>
            <span class="c1">#print(&quot;colourTable = {}&quot;.format(colourTable))</span>
            <span class="k">global</span> <span class="n">userSelectionDict</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">updateUserSelection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectedImageName</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">contrast</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateImageUserSelection: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateImageUserSelection: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="updateImageLevels"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.updateImageLevels">[docs]</a><span class="k">def</span> <span class="nf">updateImageLevels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imv</span><span class="p">,</span> <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;When the contrast and intensity values are adjusted using the spinboxes, </span>
<span class="sd">    this function sets the corresponding values in the image being viewed. </span>
<span class="sd">    </span>
<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        imv - pyqtGraph imageView widget</span>
<span class="sd">        spinBoxIntensity - name of the spinbox widget that displays/sets image intensity.</span>
<span class="sd">        spinBoxContrast - name of the spinbox widget that displays/sets image contrast.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">centre</span> <span class="o">=</span> <span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="n">halfWidth</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span>

        <span class="n">minimumValue</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">-</span> <span class="n">halfWidth</span>
        <span class="n">maximumValue</span> <span class="o">=</span> <span class="n">centre</span> <span class="o">+</span> <span class="n">halfWidth</span>
        <span class="c1">#print(&quot;centre{}, width{},  minimumValue{}, maximumValue{}&quot;.format(centre, width,  minimumValue, maximumValue))</span>
        <span class="n">imv</span><span class="o">.</span><span class="n">setLevels</span><span class="p">(</span> <span class="n">minimumValue</span><span class="p">,</span> <span class="n">maximumValue</span><span class="p">)</span>
        <span class="n">imv</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateImageLevels: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateImageLevels: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>
        

<div class="viewcode-block" id="updateDICOM"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.updateDICOM">[docs]</a><span class="k">def</span> <span class="nf">updateDICOM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lblHiddenSeriesName</span><span class="p">,</span> <span class="n">lblHiddenStudyName</span><span class="p">,</span> <span class="n">cmbColours</span><span class="p">,</span> 
                <span class="n">spinBoxIntensity</span><span class="p">,</span> <span class="n">spinBoxContrast</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is executed when the Update button </span>
<span class="sd">        is clicked and it coordinates the calling of the functions, </span>
<span class="sd">        updateWholeDicomSeries &amp; updateDicomSeriesImageByImage.</span>
<span class="sd">        </span>
<span class="sd">        Input Parmeters</span>
<span class="sd">        ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        lblHiddenSeriesName - name of the hidden label widget whose text</span>
<span class="sd">                    contains the name of the DICOM series whose images are </span>
<span class="sd">                    being viewed.</span>
<span class="sd">        lblHiddenStudyName - name of the hidden label widget whose text</span>
<span class="sd">                contains the name of the DICOM study containing the series</span>
<span class="sd">                whose images are  being viewed.</span>
<span class="sd">        cmbColours - A dropdown list of colour table names based on the QComboBox class</span>
<span class="sd">        spinBoxIntensity - name of the spinbox widget that displays/sets image intensity.</span>
<span class="sd">        spinBoxContrast - name of the spinbox widget that displays/sets image contrast.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DisplayImageColour.updateDICOM called&quot;</span><span class="p">)</span>
            <span class="n">seriesName</span> <span class="o">=</span> <span class="n">lblHiddenSeriesName</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="n">studyName</span> <span class="o">=</span> <span class="n">lblHiddenStudyName</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
            <span class="n">colourTable</span> <span class="o">=</span> <span class="n">cmbColours</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
            <span class="k">global</span> <span class="n">userSelectionDict</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span>
            <span class="c1">#print(&quot;DisplayImageColour.updateDICOM called&quot;)</span>
            <span class="c1">#print(&quot;obj.getSeriesUpdateStatus() = {}&quot;.format(obj.getSeriesUpdateStatus()))</span>
            <span class="c1">#print(&quot;obj.getImageUpdateStatus() = {}&quot;.format(obj.getImageUpdateStatus()))</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">getSeriesUpdateStatus</span><span class="p">():</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">spinBoxIntensity</span><span class="o">.</span><span class="n">value</span><span class="p">(),</span> <span class="n">spinBoxContrast</span><span class="o">.</span><span class="n">value</span><span class="p">()]</span>
                <span class="n">updateWholeDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">studyName</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">,</span> <span class="n">levels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">getImageUpdateStatus</span><span class="p">():</span>
                <span class="n">updateDicomSeriesImageByImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">studyName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateDICOM: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateDICOM: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="updateWholeDicomSeries"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.updateWholeDicomSeries">[docs]</a><span class="k">def</span> <span class="nf">updateWholeDicomSeries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">studyName</span><span class="p">,</span> <span class="n">colourTable</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">lut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates every image in a DICOM series with one colour table and</span>
<span class="sd">            one set of levels</span>
<span class="sd">            </span>
<span class="sd">      Input Parmeters</span>
<span class="sd">      ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series of images to be updated</span>
<span class="sd">        studyName - string variable containing name of the DICOMstudy </span>
<span class="sd">                containing the DICOM series of images to be updated</span>
<span class="sd">        colourTable - String variable containing the name of a colour table</span>
<span class="sd">        levels  - 2 item list containing the image contrast and intensity values as integers, </span>
<span class="sd">                    [contrast, intensity]</span>
<span class="sd">        lut - array holding a lookup table of colours. A custom colour map</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In DisplayImageColour.updateWholeDicomSeries&quot;</span><span class="p">)</span>
        <span class="n">imagePathList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objXMLReader</span><span class="o">.</span><span class="n">getImagePathList</span><span class="p">(</span><span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">)</span>

        <span class="c1">#Iterate through list of images and update each image</span>
        <span class="n">numImages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imagePathList</span><span class="p">)</span>
        <span class="n">messageWindow</span><span class="o">.</span><span class="n">displayMessageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;&lt;H4&gt;Updating </span><span class="si">{}</span><span class="s2"> DICOM files&lt;/H4&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numImages</span><span class="p">),</span>
            <span class="s2">&quot;Updating DICOM images&quot;</span><span class="p">)</span>
        <span class="n">messageWindow</span><span class="o">.</span><span class="n">setMsgWindowProgBarMaxValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numImages</span><span class="p">)</span>
        <span class="n">imageCounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">imagePath</span> <span class="ow">in</span> <span class="n">imagePathList</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">readDICOM_Image</span><span class="o">.</span><span class="n">getDicomDataset</span><span class="p">(</span><span class="n">imagePath</span><span class="p">)</span> 
            <span class="c1"># Update every DICOM file in the series                                     </span>
            <span class="n">updatedDataset</span> <span class="o">=</span> <span class="n">saveDICOM_Image</span><span class="o">.</span><span class="n">updateSingleDicom</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">colourmap</span><span class="o">=</span><span class="n">colourTable</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">lut</span><span class="o">=</span><span class="n">lut</span><span class="p">)</span>
            <span class="n">saveDICOM_Image</span><span class="o">.</span><span class="n">saveDicomToFile</span><span class="p">(</span><span class="n">updatedDataset</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">imagePath</span><span class="p">)</span>
            <span class="n">imageCounter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">messageWindow</span><span class="o">.</span><span class="n">setMsgWindowProgBarValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageCounter</span><span class="p">)</span>
        <span class="n">messageWindow</span><span class="o">.</span><span class="n">closeMessageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateWholeDicomSeries: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="updateDicomSeriesImageByImage"><a class="viewcode-back" href="../../../CoreModules.WEASEL.DisplayImageColour.html#CoreModules.WEASEL.DisplayImageColour.updateDicomSeriesImageByImage">[docs]</a><span class="k">def</span> <span class="nf">updateDicomSeriesImageByImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">,</span> <span class="n">studyName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates one or more images in a DICOM series each with potentially</span>
<span class="sd">    a different table and set of levels</span>
<span class="sd">    </span>
<span class="sd">    Input Parmeters</span>
<span class="sd">    ***************</span>
<span class="sd">        self - an object reference to the WEASEL interface.</span>
<span class="sd">        seriesName - string variable containing the name of DICOM series </span>
<span class="sd">        of images to be updated</span>
<span class="sd">        studyName - string variable containing name of the DICOMstudy </span>
<span class="sd">                containing the DICOM series of images to updated</span>
<span class="sd">        colourTable - String variable containing the name of a colour table</span>
<span class="sd">        lut - array holding a lookup table of colours. A custom colour map</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In DisplayImageColour.updateDicomSeriesImageByImage&quot;</span><span class="p">)</span>
       
        <span class="n">imagePathList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objXMLReader</span><span class="o">.</span><span class="n">getImagePathList</span><span class="p">(</span><span class="n">studyName</span><span class="p">,</span> <span class="n">seriesName</span><span class="p">)</span>

        <span class="c1">#Iterate through list of images and update each image</span>
        <span class="n">numImages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imagePathList</span><span class="p">)</span>
        <span class="n">messageWindow</span><span class="o">.</span><span class="n">displayMessageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;&lt;H4&gt;Updating </span><span class="si">{}</span><span class="s2"> DICOM files&lt;/H4&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numImages</span><span class="p">),</span>
            <span class="s2">&quot;Updating DICOM images&quot;</span><span class="p">)</span>
        <span class="n">messageWindow</span><span class="o">.</span><span class="n">setMsgWindowProgBarMaxValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numImages</span><span class="p">)</span>
        <span class="n">imageCounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">global</span> <span class="n">userSelectionDict</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">userSelectionDict</span><span class="p">[</span><span class="n">seriesName</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">imageCounter</span><span class="p">,</span> <span class="n">imagePath</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imagePathList</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1">#print(&#39;In updateDicomSeriesImageByImage, series name={}&#39;.format(seriesName))</span>
            <span class="c1"># Apply user selected colour table &amp; levels to individual images in the series</span>
            <span class="n">selectedColourMap</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">returnUserSelection</span><span class="p">(</span><span class="n">imageCounter</span><span class="p">)</span>
            <span class="c1">#print(&#39;selectedColourMap, center, width = {}, {}, {}&#39;.format(selectedColourMap, center, width))</span>
            <span class="k">if</span> <span class="n">selectedColourMap</span> <span class="o">!=</span> <span class="s1">&#39;default&#39;</span> <span class="ow">and</span> <span class="n">center</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Update an individual DICOM file in the series</span>
                <span class="c1">#print(&#39;In If, imageCounter = {}, imagePath={}&#39;.format(imageCounter, imagePath))</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="p">]</span>  
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">readDICOM_Image</span><span class="o">.</span><span class="n">getDicomDataset</span><span class="p">(</span><span class="n">imagePath</span><span class="p">)</span>
                <span class="n">updatedDataset</span> <span class="o">=</span> <span class="n">saveDICOM_Image</span><span class="o">.</span><span class="n">updateSingleDicom</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">colourmap</span><span class="o">=</span><span class="n">selectedColourMap</span><span class="p">,</span> 
                                                    <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">lut</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">saveDICOM_Image</span><span class="o">.</span><span class="n">saveDicomToFile</span><span class="p">(</span><span class="n">updatedDataset</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">imagePath</span><span class="p">)</span>
            <span class="n">messageWindow</span><span class="o">.</span><span class="n">setMsgWindowProgBarValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imageCounter</span><span class="p">)</span>
        <span class="n">messageWindow</span><span class="o">.</span><span class="n">closeMessageSubWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error in DisplayImageColour.updateDicomSeriesImageByImage: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Steve Shillitoe, Joao Sousa and Steven Sourbron
      <span class="lastupdated">
        Last updated on True.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>